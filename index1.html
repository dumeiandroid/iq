<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Sertifikat IQ ‚Äî Lidan Psikologi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --crimson: #BF1A54;
            --crimson-dark: #8c1240;
            --navy: #1a2a4a;
            --gold: #c9a84c;
            --cream: #fdf8f2;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--navy); min-height: 100vh; }
        .font-display { font-family: 'Playfair Display', serif; }

        .site-header {
            background: var(--navy); border-bottom: 3px solid var(--gold);
            padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 24px rgba(26,42,74,0.3);
        }
        .logo-area { display: flex; align-items: center; gap: 14px; }
        .logo-area img { height: 42px; }
        .logo-text .main { font-family: 'Playfair Display', serif; color: #fff; font-size: 18px; font-weight: 700; }
        .logo-text .sub { color: var(--gold); font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; }

        .stat-card {
            background: white; border-radius: 16px; padding: 20px 28px;
            border: 1px solid #e8ddd0; box-shadow: 0 2px 12px rgba(26,42,74,0.06);
            display: flex; align-items: center; gap: 16px;
        }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .stat-num { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 900; color: var(--navy); }
        .stat-label { font-size: 12px; color: #7a8090; text-transform: uppercase; letter-spacing: 0.08em; }

        .data-table { width: 100%; border-collapse: collapse; }
        .data-table thead th {
            background: var(--navy); color: white; padding: 14px 16px;
            font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; text-align: left;
        }
        .data-table tbody tr { border-bottom: 1px solid #ede8e0; transition: background 0.15s; }
        .data-table tbody tr:hover { background: #fff8f0; }
        .data-table tbody td { padding: 12px 16px; font-size: 14px; vertical-align: middle; }

        .score-badge {
            display: inline-flex; align-items: center; justify-content: center;
            width: 52px; height: 52px; border-radius: 50%;
            font-family: 'Playfair Display', serif; font-weight: 900; font-size: 16px; border: 2px solid;
        }
        .s-genius { background:#fef3c7; color:#92400e; border-color:#f59e0b; }
        .s-vsup   { background:#ede9fe; color:#4c1d95; border-color:#7c3aed; }
        .s-sup    { background:#dbeafe; color:#1e40af; border-color:#3b82f6; }
        .s-above  { background:#cffafe; color:#164e63; border-color:#06b6d4; }
        .s-avg    { background:#d1fae5; color:#065f46; border-color:#10b981; }
        .s-below  { background:#fef9c3; color:#713f12; border-color:#eab308; }
        .s-slow   { background:#fee2e2; color:#991b1b; border-color:#ef4444; }

        .cat-tag { display: inline-block; padding: 3px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; }

        .btn {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 7px 13px; border-radius: 8px; font-size: 12px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.15s; text-decoration: none; white-space: nowrap;
        }
        .btn-primary { background: var(--crimson); color: white; }
        .btn-primary:hover { background: var(--crimson-dark); transform: translateY(-1px); }
        .btn-edit    { background: var(--navy); color: white; }
        .btn-edit:hover { background: #263a5e; }
        .btn-cert    { background: var(--gold); color: var(--navy); }
        .btn-cert:hover { background: #b8933e; }
        .btn-verify  { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .btn-verify:hover { background: #bae6fd; }
        .btn-del     { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; padding: 7px 10px; }
        .btn-del:hover { background: #fecaca; }
        .btn-outline { background: transparent; color: var(--navy); border: 1.5px solid #ddd; }
        .btn-outline:hover { border-color: var(--navy); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(26,42,74,0.75);
            backdrop-filter: blur(4px); z-index: 200;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box {
            background: white; border-radius: 20px;
            width: 100%; max-width: 680px; max-height: 92vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            background: var(--navy); padding: 22px 28px; border-radius: 20px 20px 0 0;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 10;
        }
        .modal-header h3 { font-family: 'Playfair Display', serif; color: white; font-size: 20px; }
        .modal-close { background: rgba(255,255,255,0.12); border: none; color: white; border-radius: 8px; padding: 6px 11px; cursor: pointer; font-size: 18px; line-height: 1; }
        .modal-close:hover { background: rgba(255,255,255,0.22); }
        .modal-body { padding: 28px; }
        .modal-footer { padding: 16px 28px 24px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid #f0f0f0; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #555; }
        .form-group input, .form-group select, .form-group textarea {
            border: 1.5px solid #e5e7eb; border-radius: 10px; padding: 10px 14px;
            font-size: 14px; font-family: 'DM Sans', sans-serif; transition: border-color 0.15s; background: #fafafa; color: var(--navy);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--crimson); background: white; box-shadow: 0 0 0 3px rgba(191,26,84,0.08);
        }
        .form-group input[readonly] { background: #f0f4f8; color: #6b7280; cursor: default; }
        .form-section-title {
            font-family: 'Playfair Display', serif; font-size: 13px; color: var(--crimson);
            border-bottom: 1px solid #ede8e0; padding-bottom: 6px; margin-top: 6px; grid-column: 1/-1;
        }

        .search-wrapper { position: relative; }
        .search-input {
            border: 1.5px solid #ddd; border-radius: 10px; padding: 10px 16px 10px 38px;
            font-size: 14px; font-family: 'DM Sans', sans-serif; background: white;
        }
        .search-input:focus { outline: none; border-color: var(--crimson); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #bbb; font-size: 14px; pointer-events: none; }

        .notif {
            position: fixed; top: 80px; right: 24px; padding: 14px 20px; border-radius: 12px;
            font-size: 14px; font-weight: 600; z-index: 500; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            transform: translateX(130%); transition: transform 0.3s ease; max-width: 360px;
        }
        .notif.show { transform: translateX(0); }
        .notif-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .notif-error   { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 18px; color: #6b7280; }

        .page-btn {
            width: 34px; height: 34px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 600; cursor: pointer;
            border: 1.5px solid #ddd; background: white; color: var(--navy); transition: all 0.15s;
        }
        .page-btn:hover { border-color: var(--crimson); color: var(--crimson); }
        .page-btn.active { background: var(--crimson); border-color: var(--crimson); color: white; }

        .confirm-overlay {
            position: fixed; inset: 0; background: rgba(26,42,74,0.65);
            z-index: 300; display: flex; align-items: center; justify-content: center;
        }
        .confirm-box {
            background: white; border-radius: 20px; padding: 36px;
            max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.25); text-align: center;
        }

        .spinner {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
            border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="notif" class="notif"></div>

<!-- HEADER -->
<header class="site-header">
    <div class="logo-area">
        <img src="https://lidan.co.id/gambar/logo-baru.png" alt="Logo Lidan" onerror="this.style.display='none'">
        <div class="logo-text">
            <div class="main">Lidan Psikologi Indonesia</div>
            <div class="sub">IQ Certificate Management System</div>
        </div>
    </div>
    <button class="btn btn-primary" onclick="openModal()" style="font-size:14px; padding:10px 20px;">
        Ôºã Tambah Data Tes IQ
    </button>
</header>

<main style="max-width:1300px; margin:0 auto; padding:32px 24px;">

    <!-- STATS -->
    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:32px;">
        <div class="stat-card">
            <div class="stat-icon" style="background:#fff0f5;">üìã</div>
            <div><div class="stat-num" id="stat-total">‚Äî</div><div class="stat-label">Total Peserta</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#fffbeb;">üß†</div>
            <div><div class="stat-num" id="stat-avg">‚Äî</div><div class="stat-label">Rata-rata IQ</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#f0fdf4;">‚≠ê</div>
            <div><div class="stat-num" id="stat-high">‚Äî</div><div class="stat-label">IQ Tertinggi</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#eff6ff;">üìÖ</div>
            <div><div class="stat-num" id="stat-month">‚Äî</div><div class="stat-label">Bulan Ini</div></div>
        </div>
    </div>

    <!-- TABLE CARD -->
    <div style="background:white; border-radius:20px; border:1px solid #e8ddd0; box-shadow:0 4px 20px rgba(26,42,74,0.06); overflow:hidden;">
        <div style="padding:20px 24px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #ede8e0; flex-wrap:wrap; gap:12px;">
            <div>
                <h2 class="font-display" style="font-size:20px; color:var(--navy);">Data Sertifikat IQ</h2>
                <p style="font-size:12px; color:#7a8090; margin-top:3px;">Kelola seluruh data tes psikologi IQ</p>
            </div>
            <div class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" class="search-input" placeholder="Cari nama peserta..." oninput="filterTable()" style="width:260px;">
            </div>
        </div>

        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width:40px;">#</th>
                        <th>Nama Peserta</th>
                        <th>Usia / JK</th>
                        <th>Tanggal Tes</th>
                        <th style="text-align:center;">Skor IQ</th>
                        <th>Kategori</th>
                        <th>No. Sertifikat</th>
                        <th style="text-align:center; width:240px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="data-tbody">
                    <tr><td colspan="8"><div class="empty-state"><div class="icon">‚è≥</div><h3>Memuat data...</h3></div></td></tr>
                </tbody>
            </table>
        </div>

        <div style="padding:16px 24px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #ede8e0; flex-wrap:wrap; gap:8px;">
            <span id="page-info" style="font-size:13px; color:#7a8090;"></span>
            <div id="page-btns" style="display:flex; gap:6px;"></div>
        </div>
    </div>
</main>

<!-- MODAL -->
<div id="modal" class="modal-overlay" style="display:none;" onclick="closeModalOutside(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modal-title">Tambah Data Tes IQ</h3>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-section-title">üë§ Identitas Peserta</div>
                <div class="form-group full">
                    <label>Nama Lengkap *</label>
                    <input type="text" id="f-nama" placeholder="Masukkan nama lengkap peserta">
                </div>
                <div class="form-group">
                    <label>Usia (tahun) *</label>
                    <input type="number" id="f-usia" placeholder="Contoh: 25" min="1" max="120">
                </div>
                <div class="form-group">
                    <label>Jenis Kelamin *</label>
                    <select id="f-jk">
                        <option value="">-- Pilih --</option>
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nomor Telepon</label>
                    <input type="tel" id="f-telp" placeholder="08xxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="f-email" placeholder="email@contoh.com">
                </div>
                <div class="form-group">
                    <label>Pendidikan Terakhir</label>
                    <select id="f-pendidikan">
                        <option value="">-- Pilih --</option>
                        <option>SD</option><option>SMP</option><option>SMA/SMK</option>
                        <option>D3</option><option>S1</option><option>S2</option><option>S3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pekerjaan / Instansi</label>
                    <input type="text" id="f-pekerjaan" placeholder="Perusahaan atau instansi">
                </div>

                <div class="form-section-title" style="margin-top:8px;">üß™ Data Hasil Tes</div>
                <div class="form-group">
                    <label>Tanggal Tes *</label>
                    <input type="date" id="f-tanggal">
                </div>
                <div class="form-group">
                    <label>Skor IQ *</label>
                    <input type="number" id="f-skor" placeholder="Contoh: 115" min="40" max="200">
                </div>
                <div class="form-group full">
                    <label>Alat Tes yang Digunakan</label>
                    <select id="f-alat">
                        <option value="CFIT (Culture Fair Intelligence Test)">CFIT ‚Äì Culture Fair Intelligence Test</option>
                        <option value="SPM (Standard Progressive Matrices)">SPM ‚Äì Standard Progressive Matrices (Raven)</option>
                        <option value="APM (Advanced Progressive Matrices)">APM ‚Äì Advanced Progressive Matrices</option>
                        <option value="WAIS (Wechsler Adult Intelligence Scale)">WAIS ‚Äì Wechsler Adult Intelligence Scale</option>
                        <option value="IST (Intelligenz Struktur Test)">IST ‚Äì Intelligenz Struktur Test</option>
                        <option value="TKD (Tes Kemampuan Dasar)">TKD ‚Äì Tes Kemampuan Dasar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nama Psikolog / Penguji</label>
                    <input type="text" id="f-penguji" placeholder="Nama lengkap psikolog">
                </div>
                <div class="form-group">
                    <label>No. SIPP Psikolog</label>
                    <input type="text" id="f-sipp" placeholder="Nomor Surat Izin Praktik">
                </div>
                <div class="form-group full">
                    <label>No. Sertifikat <span style="color:#aaa; font-size:10px; font-weight:400;">(auto: MaxID+1+100 / BLN / IQ / TAHUN)</span></label>
                    <input type="text" id="f-nosert" readonly>
                </div>
                <div class="form-group full">
                    <label>Token Unik (ID Sertifikat)</label>
                    <input type="text" id="f-token" readonly>
                </div>
                <div class="form-group full">
                    <label>Catatan / Rekomendasi Psikolog</label>
                    <textarea id="f-catatan" rows="3" placeholder="Catatan tambahan dari psikolog..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal()">Batal</button>
            <button class="btn btn-primary" id="save-btn" onclick="saveData()" style="padding:10px 24px;">üíæ Simpan Data</button>
        </div>
    </div>
</div>

<!-- CONFIRM DELETE -->
<div id="confirm-overlay" class="confirm-overlay" style="display:none;">
    <div class="confirm-box">
        <div style="font-size:48px; margin-bottom:16px;">üóëÔ∏è</div>
        <h3 class="font-display" style="font-size:22px; color:var(--navy); margin-bottom:10px;">Hapus Data?</h3>
        <p style="font-size:14px; color:#6b7280; margin-bottom:28px; line-height:1.6;">
            Data peserta dan sertifikat akan dihapus permanen.<br>Tindakan ini tidak dapat dibatalkan.
        </p>
        <div style="display:flex; gap:12px; justify-content:center;">
            <button class="btn btn-outline" style="padding:10px 24px;" onclick="cancelDelete()">Batal</button>
            <button id="del-confirm-btn" class="btn" style="background:#dc2626; color:white; padding:10px 24px;" onclick="confirmDelete()">Ya, Hapus</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KONFIGURASI API
//  Satu endpoint untuk semua operasi: GET / POST / PUT / DELETE
//  GET    ‚Üí ambil data         ‚Üí fetch(url, {method:'GET'})
//  POST   ‚Üí insert baru        ‚Üí fetch(url+'?table=iq', {method:'POST', body:JSON})
//  PUT    ‚Üí update by id_x     ‚Üí fetch(url+'?table=iq&id_x=N', {method:'PUT', body:JSON})
//  DELETE ‚Üí delete by id_x     ‚Üí fetch(url+'?table=iq&id_x=N', {method:'DELETE'})
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_URL  = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6';
const TABLE    = 'iq';
const AUTH_KEY = 'admin';

let allData      = [];
let filtered     = [];
let currentPage  = 1;
const PER_PAGE   = 10;
let editingIdX   = null;   // id_x integer dari DB (dipakai untuk PUT & DELETE)
let deleteIdX    = null;

// ‚îÄ‚îÄ IQ CATEGORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getIQCategory(score) {
    score = parseInt(score);
    if (score >= 160) return { label:'Genius',             cls:'s-genius', bg:'#fef3c7', col:'#92400e' };
    if (score >= 130) return { label:'Sangat Superior',    cls:'s-vsup',   bg:'#ede9fe', col:'#4c1d95' };
    if (score >= 120) return { label:'Superior',           cls:'s-sup',    bg:'#dbeafe', col:'#1e40af' };
    if (score >= 110) return { label:'Di Atas Rata-rata',  cls:'s-above',  bg:'#cffafe', col:'#164e63' };
    if (score >=  90) return { label:'Rata-rata',          cls:'s-avg',    bg:'#d1fae5', col:'#065f46' };
    if (score >=  80) return { label:'Di Bawah Rata-rata', cls:'s-below',  bg:'#fef9c3', col:'#713f12' };
    return                   { label:'Lambat Belajar',     cls:'s-slow',   bg:'#fee2e2', col:'#991b1b' };
}

function formatDate(str) {
    if (!str) return '-';
    const p = str.split('-');
    return p.length === 3 ? `${p[2]}-${p[1]}-${p[0]}` : str;
}

function genToken() {
    return 'IQ-' + Date.now() + '-' + Math.random().toString(36).substr(2,6).toUpperCase();
}

// Auto Nomor Sertifikat: (MaxID + 1 + 100) / BLN / IQ / TAHUN
function genCertNo() {
    const now   = new Date();
    const year  = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    let maxId   = 0;
    allData.forEach(d => { const n = parseInt(d.id_x || 0); if (n > maxId) maxId = n; });
    return `${maxId + 1 + 100}/${month}/IQ/${year}`;
}

// ‚îÄ‚îÄ FETCH DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchData() {
    try {
        const res    = await fetch(`${API_URL}?table=${TABLE}`, {
            headers: { 'X-Custom-Auth': AUTH_KEY }
        });
        const result = await res.json();
        if (result.success) {
            allData  = result.data || [];
            filtered = [...allData];
            updateStats();
            renderTable();
        } else {
            showEmptyState('Gagal memuat data: ' + (result.error || ''));
        }
    } catch (e) {
        console.error(e);
        showEmptyState('Koneksi gagal. Pastikan diakses via server (bukan file://).');
    }
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
    document.getElementById('stat-total').innerText = allData.length;
    const scores = allData.map(d => parseInt(d.x_07||0)).filter(s=>s>0);
    document.getElementById('stat-avg').innerText  = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : '‚Äî';
    document.getElementById('stat-high').innerText = scores.length ? Math.max(...scores) : '‚Äî';
    const m = new Date().getMonth(), y = new Date().getFullYear();
    document.getElementById('stat-month').innerText = allData.filter(d=>{
        if(!d.x_05) return false;
        const dt=new Date(d.x_05); return dt.getMonth()===m && dt.getFullYear()===y;
    }).length;
}

// ‚îÄ‚îÄ RENDER TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTable() {
    const tbody = document.getElementById('data-tbody');
    if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon">üîç</div><h3>Tidak ada data ditemukan</h3></div></td></tr>`;
        document.getElementById('page-info').innerText = '';
        document.getElementById('page-btns').innerHTML = '';
        return;
    }
    const start    = (currentPage-1)*PER_PAGE;
    const pageData = filtered.slice(start, start+PER_PAGE);

    tbody.innerHTML = pageData.map((d,i) => {
        const cat   = getIQCategory(d.x_07);
        const token = d.x_12 || '';
        return `
        <tr>
            <td style="color:#bbb;font-size:12px;">${start+i+1}</td>
            <td>
                <div style="font-weight:700;color:var(--navy);">${d.x_01||'-'}</div>
                <div style="font-size:11px;color:#9ca3af;margin-top:2px;">${d.x_03||''}</div>
            </td>
            <td>
                <div style="font-size:13px;">${d.x_02||'-'} thn</div>
                <div style="font-size:11px;color:#9ca3af;">${d.x_06||'-'}</div>
            </td>
            <td style="font-size:13px;">${formatDate(d.x_05)}</td>
            <td style="text-align:center;">
                <div class="score-badge ${cat.cls}">${d.x_07||'-'}</div>
            </td>
            <td><span class="cat-tag" style="background:${cat.bg};color:${cat.col};">${cat.label}</span></td>
            <td style="font-size:11px;color:#6b7280;font-family:monospace;">${d.x_11||'‚Äî'}</td>
            <td style="text-align:center;">
                <div style="display:flex;gap:4px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn btn-edit"  onclick="openEdit(${d.id_x})">‚úèÔ∏è Edit</button>
                    <a class="btn btn-cert"   href="iq_hard.html?token=${token}" target="_blank">üìú Sertifikat</a>
                    <a class="btn btn-verify" href="iq.html?token=${token}" target="_blank">üîç Verify</a>
                    <button class="btn btn-del" onclick="askDelete(${d.id_x})" title="Hapus">üóëÔ∏è</button>
                </div>
            </td>
        </tr>`;
    }).join('');

    const total      = filtered.length;
    const totalPages = Math.ceil(total/PER_PAGE);
    document.getElementById('page-info').innerText = `Menampilkan ${start+1}‚Äì${Math.min(start+PER_PAGE,total)} dari ${total} data`;

    const pageBtns = document.getElementById('page-btns');
    pageBtns.innerHTML = '';
    for (let p=1; p<=totalPages; p++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn' + (p===currentPage?' active':'');
        btn.innerText = p;
        btn.onclick   = () => { currentPage=p; renderTable(); };
        pageBtns.appendChild(btn);
    }
}

function filterTable() {
    const q  = document.getElementById('search-input').value.toLowerCase();
    filtered = allData.filter(d =>
        (d.x_01||'').toLowerCase().includes(q) ||
        (d.x_03||'').toLowerCase().includes(q) ||
        (d.x_11||'').toLowerCase().includes(q)
    );
    currentPage = 1;
    renderTable();
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
    editingIdX = null;
    document.getElementById('modal-title').innerText = 'Tambah Data Tes IQ';
    clearForm();
    document.getElementById('f-nosert').value = genCertNo();
    document.getElementById('f-token').value  = genToken();
    document.getElementById('modal').style.display = 'flex';
}

function openEdit(idX) {
    const d = allData.find(r => r.id_x == idX);
    if (!d) return;
    editingIdX = idX;
    document.getElementById('modal-title').innerText = 'Edit Data Tes IQ';
    document.getElementById('f-nama').value       = d.x_01 || '';
    document.getElementById('f-usia').value       = d.x_02 || '';
    document.getElementById('f-telp').value       = d.x_03 || '';
    document.getElementById('f-email').value      = d.x_04 || '';
    document.getElementById('f-tanggal').value    = d.x_05 || '';
    document.getElementById('f-jk').value         = d.x_06 || '';
    document.getElementById('f-skor').value       = d.x_07 || '';
    document.getElementById('f-alat').value       = d.x_08 || '';
    document.getElementById('f-penguji').value    = d.x_09 || '';
    document.getElementById('f-sipp').value       = d.x_10 || '';
    document.getElementById('f-nosert').value     = d.x_11 || '';
    document.getElementById('f-token').value      = d.x_12 || '';
    document.getElementById('f-pendidikan').value = d.x_13 || '';
    document.getElementById('f-pekerjaan').value  = d.x_14 || '';
    document.getElementById('f-catatan').value    = d.x_15 || '';
    document.getElementById('modal').style.display = 'flex';
}

function closeModal() { document.getElementById('modal').style.display='none'; editingIdX=null; }
function closeModalOutside(e) { if(e.target.id==='modal') closeModal(); }

function clearForm() {
    ['f-nama','f-usia','f-telp','f-email','f-skor','f-penguji','f-sipp','f-nosert','f-token','f-pekerjaan','f-catatan'].forEach(id=>{
        document.getElementById(id).value='';
    });
    document.getElementById('f-jk').value         = '';
    document.getElementById('f-pendidikan').value  = '';
    document.getElementById('f-alat').value        = 'CFIT (Culture Fair Intelligence Test)';
    document.getElementById('f-tanggal').value     = new Date().toISOString().split('T')[0];
}

// ‚îÄ‚îÄ SAVE (INSERT / UPDATE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveData() {
    const nama    = document.getElementById('f-nama').value.trim();
    const skor    = document.getElementById('f-skor').value.trim();
    const tanggal = document.getElementById('f-tanggal').value;
    const jk      = document.getElementById('f-jk').value;

    if (!nama)    { showNotif('‚ö†Ô∏è Nama peserta wajib diisi.','error'); return; }
    if (!skor)    { showNotif('‚ö†Ô∏è Skor IQ wajib diisi.','error'); return; }
    if (!tanggal) { showNotif('‚ö†Ô∏è Tanggal tes wajib diisi.','error'); return; }
    if (!jk)      { showNotif('‚ö†Ô∏è Jenis kelamin wajib dipilih.','error'); return; }

    const token  = document.getElementById('f-token').value  || genToken();
    const nosert = document.getElementById('f-nosert').value || genCertNo();

    const payload = {
        x_01: nama,
        x_02: document.getElementById('f-usia').value,
        x_03: document.getElementById('f-telp').value,
        x_04: document.getElementById('f-email').value,
        x_05: tanggal,
        x_06: jk,
        x_07: skor,
        x_08: document.getElementById('f-alat').value,
        x_09: document.getElementById('f-penguji').value,
        x_10: document.getElementById('f-sipp').value,
        x_11: nosert,
        x_12: token,
        x_13: document.getElementById('f-pendidikan').value,
        x_14: document.getElementById('f-pekerjaan').value,
        x_15: document.getElementById('f-catatan').value,
    };

    const saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner"></span> Menyimpan...';

    try {
        let url, method;
        if (editingIdX) {
            // UPDATE ‚Äî PUT ke endpoint yg sama + ?table=iq&id_x={id_x}
            url    = `${API_URL}?table=${TABLE}&id_x=${editingIdX}`;
            method = 'PUT';
        } else {
            // INSERT ‚Äî POST ke endpoint yg sama + ?table=iq
            url    = `${API_URL}?table=${TABLE}`;
            method = 'POST';
        }

        const res    = await fetch(url, {
            method,
            headers: {
                'Content-Type':  'application/json',
                'X-Custom-Auth': AUTH_KEY
            },
            body: JSON.stringify(payload)
        });

        const result = await res.json();
        console.log('API response:', result);

        if (res.ok && result.success !== false) {
            showNotif(editingIdX ? '‚úÖ Data berhasil diperbarui!' : '‚úÖ Data berhasil disimpan!', 'success');
            closeModal();
            await fetchData();
        } else {
            showNotif('‚ùå ' + (result.error || result.message || 'Gagal menyimpan.'), 'error');
        }
    } catch (e) {
        console.error('saveData error:', e);
        showNotif('‚ùå Koneksi gagal: ' + e.message, 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'üíæ Simpan Data';
    }
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function askDelete(idX) {
    deleteIdX = idX;
    document.getElementById('confirm-overlay').style.display = 'flex';
}
function cancelDelete() {
    deleteIdX = null;
    document.getElementById('confirm-overlay').style.display = 'none';
}
async function confirmDelete() {
    if (!deleteIdX) return;
    const btn = document.getElementById('del-confirm-btn');
    btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';

    try {
        // DELETE ‚Äî method DELETE ke endpoint yg sama + ?table=iq&id_x={id_x}
        const res    = await fetch(`${API_URL}?table=${TABLE}&id_x=${deleteIdX}`, {
            method:  'DELETE',
            headers: { 'X-Custom-Auth': AUTH_KEY }
        });
        const result = await res.json();
        cancelDelete();
        if (res.ok && result.success !== false) {
            showNotif('‚úÖ Data berhasil dihapus.', 'success');
            await fetchData();
        } else {
            showNotif('‚ùå ' + (result.message || result.error || 'Gagal menghapus.'), 'error');
        }
    } catch (e) {
        cancelDelete();
        showNotif('‚ùå Koneksi gagal saat menghapus.', 'error');
    }
}

// ‚îÄ‚îÄ NOTIF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showNotif(msg, type='info') {
    const el = document.getElementById('notif');
    el.innerText = msg;
    el.className = `notif notif-${type} show`;
    setTimeout(() => el.classList.remove('show'), 3500);
}
function showEmptyState(msg) {
    document.getElementById('data-tbody').innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="icon">‚ö†Ô∏è</div><h3>${msg}</h3></div></td></tr>`;
}

document.addEventListener('DOMContentLoaded', fetchData);
</script>
</body>
</html>